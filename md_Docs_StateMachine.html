<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>CORC Project: Designing Finite State Machines using CORC</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">CORC Project
   </div>
   <div id="projectbrief">CANOpen Robot Controller Software Documentation</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Packages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Designing Finite <a class="el" href="classState.html" title="Abstract class representing a state in a StateMachine. ">State</a> Machines using CORC </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>What is a Finite <a class="el" href="classState.html" title="Abstract class representing a state in a StateMachine. ">State</a> Machine (FSM)</h2>
<ul>
<li>A reactive system whose response to a particular stimulus (a signal, or a piece of input) is not the same on every occasion, depending on its current “state”.<ul>
<li>For example, in the case of a Vending machine, it will not despense a chocolate bar when you make a selection unless you have already inserted the correct amount of money. Thus, the response to the selection button depends on the previous history of the use of the system.</li>
</ul>
</li>
</ul>
<h2>Why FSM in Robotics</h2>
<ul>
<li><a class="el" href="classRobot.html" title="Abstract Class representing a robot. Includes vectors of Joint and InputDevice. ">Robot</a> behaviour is inherently reactive. Response to an event at any moment, is dependent on the “state” of the robot.</li>
<li>Safety: To avoid states (motion or behaviour) with disastrous consequences, FSM only allow pre-determined state transitions.<ul>
<li>Never begin a motion unless in a safe starting position.</li>
<li>Never keep rocket engines on for more than n seconds.</li>
<li>(Therac-25 accident)<a href="https://ieeexplore.ieee.org/document/274940">An investigation of the Therac-25 accidents - IEEE Journals &amp; Magazine</a></li>
</ul>
</li>
</ul>
<h2>How to Structure <a class="el" href="classState.html" title="Abstract class representing a state in a StateMachine. ">State</a> Machine Code</h2>
<p>CORC provides a structured way to build event driven FSMs. The following explains how to represent states and events and how to put them together into a CORC state machine. It is best practice to start with a state transition diagram and build each component individually. We will use the <a class="el" href="classExoTestMachine.html" title="Example implementation of a StateMachine for the ExoRobot class. States should implemented ExoTestSta...">ExoTestMachine</a> example provided in the CORC library <a href="https://github.com/UniMelbHumanRoboticsLab/CANOpenRobotController/blob/master/src/apps/stateMachine/ExoTestMachine.cpp">link</a> presented bellow.</p>
<div class="image">
<img src="https://exoembedded.readthedocs.io/en/latest/img/exoTestMachine.png"  alt="exoTestMachine"/>
</div>
<ul>
<li>An Input Device (e.g. keyboard, controller etc) triggers Events. The desired behaviour is to move the exoskeleton between a sitting position and standing position. Using two moving states (sittingDwn and standingUp. We don't care how those motions happen, only the separation of individual <a class="el" href="classState.html" title="Abstract class representing a state in a StateMachine. ">State</a>. This both seperates programatically and prevents unwanted behaviours.</li>
</ul>
<h2>States</h2>
<ul>
<li>States can either have an associated action with them (sitting Down), or no action (sitting), which differ them from each other.</li>
<li>Programatically we design each state as a separate class which must implement the following three functions.</li>
<li>The presiding Statemachine calls entry, exit and during their existence. In this view a state can be thought of as the description and behaviour of a system that is waiting to execute a transition.</li>
</ul>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;{C++}</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;      virtual void entry(void);</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;            -&gt; 1 time set ups</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;        virtual void durring(void);</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;            -&gt; Called by update method of the state machine</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;            -&gt; *CONTINUOUS UPDATE AND CONTROL LIVES HERE*</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;                *MOTOR CONTROL*</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;        virtual void exit(void);</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;            -&gt; transition out of the state triggers this, release resources.</div></div><!-- fragment --><p>For example the SittingDown class:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;{C++}</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;void SittingDwn::entry(void) {</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;    cout &lt;&lt; &quot; GREEN -&gt; SIT DOWN &quot; &lt;&lt; endl</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;    trajectoryGenerator-&gt;initialiseTrajectory(SIT, 1);</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;    robot-&gt;startNewTraj();</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;}</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;void SittingDwn::during(void) {</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;    robot-&gt;moveThroughTraj();</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;}</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;void SittingDwn::exit(void) {</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;    std::cout &lt;&lt; &quot;Sitting Down State Exited &quot; &lt;&lt; endl;</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;}</div></div><!-- fragment --><h2>Events</h2>
<p>Events could a sensor trigger, timer finishing, end of a trajectory or anything in between. When an event happens:</p>
<ul>
<li>The event is checked against the <b>current state**’s transitions.</b></li>
<li><b>If a transition matches the event, that transition “happens”.</b></li>
<li><b>By virtue of a transition “happening”, states are **exited</b>, and <b>entered</b> and the relevant actions are performed</li>
<li>The machine immediately <b>is in</b> the new state, ready to process the next event.</li>
<li>CORC represents events as single method objects comprising as Boolean functions <code>virtual Boolean method: check()</code>. For example:</li>
</ul>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;{C++}</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;bool ExoTestMachine::EndTraj::check() {</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;    return OWNER-&gt;trajectoryGenerator-&gt;isTrajectoryFinished();</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;}</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;bool ExoTestMachine::IsAPressed::check(void) {</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;    if (OWNER-&gt;robot-&gt;keyboard.getA() == true) {</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;        return true;</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;    }</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;    return false;</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;}</div></div><!-- fragment --><h2>Transitions</h2>
<p>A transition represents a shift from one <a class="el" href="classState.html" title="Abstract class representing a state in a StateMachine. ">State</a> to another, triggered by a specific <a class="el" href="classEvent.html" title="Abstract class for events used as StateMachine triggers to transition between states. Events must be explicitly tied to a current State and state to transition to once the event has been triggered. This is done using a Transition object in a designed StateMachine. ">Event</a> (arrow in the above diagram).</p>
<ul>
<li><a class="el" href="classTransition.html" title="Represents possible transitions linking two State objects with an Event. ">Transition</a> objects have a pointer to the <a class="el" href="classEvent.html" title="Abstract class for events used as StateMachine triggers to transition between states. Events must be explicitly tied to a current State and state to transition to once the event has been triggered. This is done using a Transition object in a designed StateMachine. ">Event</a> and the toState, which for a transition object is called a target. Simply a target <a class="el" href="classState.html" title="Abstract class representing a state in a StateMachine. ">State</a> triggered by an <a class="el" href="classEvent.html" title="Abstract class for events used as StateMachine triggers to transition between states. Events must be explicitly tied to a current State and state to transition to once the event has been triggered. This is done using a Transition object in a designed StateMachine. ">Event</a>.</li>
<li>Programatically this is captured by the fromState holding all possible transition objects in an archList. A list of all possible transitions this state can transition too. - The overlaying <a class="el" href="classState.html" title="Abstract class representing a state in a StateMachine. ">State</a> machine asks the current state to check its Archlist for any Triggered transitions. If a transition event is triggered, the transition object provides the stjatemachine a pointer to its ToState. This now becomes the current state. Define each transition by specifying :<ul>
<li>FromState - the starting state for this transition</li>
<li>ToState - the end state for this transition</li>
<li><a class="el" href="classEvent.html" title="Abstract class for events used as StateMachine triggers to transition between states. Events must be explicitly tied to a current State and state to transition to once the event has been triggered. This is done using a Transition object in a designed StateMachine. ">Event( Condition)</a> - a callable which when it returns True means this transition is valid</li>
<li>Use <code><a class="el" href="StateMachine_8h.html#a485a4b81b2e164b0d3797b49473be673" title="Macro to create statemachine transitions. Add a tranition object to the from states arch list to a sp...">NewTransition(_from_, _event_, _to_)</a></code> MACRO to achieve this.</li>
</ul>
</li>
</ul>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;{C++}</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;\*Define sitting transitions*\</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;    NewTransition(initState, startExo, sitting);</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;    NewTransition(sitting, startStand, standingUp);</div></div><!-- fragment --><h2>Putting everything together in a stateMachine class.</h2>
<p>The base state machine class relies on cyclic calls to update(). - Each statemachine starts with a call to initialize(state) setting the currentState pointer to the fed in state object, - After the initialization call each loop of a program must cyclically call statemachine.update() and a program will transition from state to state based on the events which occur. - The update() function achieves this with two calls - Checks the currentStates ArcList for any triggered Transitions (that transition objects <a class="el" href="classEvent.html" title="Abstract class for events used as StateMachine triggers to transition between states. Events must be explicitly tied to a current State and state to transition to once the event has been triggered. This is done using a Transition object in a designed StateMachine. ">Event</a>). - If an <a class="el" href="classEvent.html" title="Abstract class for events used as StateMachine triggers to transition between states. Events must be explicitly tied to a current State and state to transition to once the event has been triggered. This is done using a Transition object in a designed StateMachine. ">Event</a> has been triggered, a sequence of calls exits the current state and sets the target to the current state. - Else if no <a class="el" href="classEvent.html" title="Abstract class for events used as StateMachine triggers to transition between states. Events must be explicitly tied to a current State and state to transition to once the event has been triggered. This is done using a Transition object in a designed StateMachine. ">Event</a> triggers a transition, the currentStates during function is called. - This sequence is repeated until program exit.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;{C++}</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;void StateMachine::update()</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;{</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;    Transition *t = currentState-&gt;getActiveArc();</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;    if (t != NULL)</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;    {</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;        currentState-&gt;exit();</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;        currentState = t-&gt;target;</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;        currentState-&gt;entry();</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;    }</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;    currentState-&gt;during();</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;}</div></div><!-- fragment --><h2>Designing your own stateMachine</h2>
<p>Following the <a class="el" href="classExoTestMachine.html" title="Example implementation of a StateMachine for the ExoRobot class. States should implemented ExoTestSta...">ExoTestMachine</a> example <a href="https://github.com/UniMelbHumanRoboticsLab/CANOpenRobotController/blob/master/src/apps/stateMachine/ExoTestMachine.cpp">link</a> , the following steps should yield a functional state machine.</p>
<ol type="1">
<li>Design a state diagram with states, events and transitions (states may have more than one possible transition)</li>
<li>Create each state classes three virtual functions following the above <a class="el" href="SittingDwn_8cpp.html">SittingDwn.cpp</a> as example</li>
<li>In your Statemachine class create pointers to state objects and populate with objects: <code><a class="el" href="classInitState.html" title="Initialisation State for the ExoTestMachine (implementing ExoTestState) ">InitState</a> *initState;</code> &amp;<code>initState = new <a class="el" href="classInitState.html" title="Initialisation State for the ExoTestMachine (implementing ExoTestState) ">InitState(*this*, robot, trajectoryGenerator)</a>;</code></li>
<li>Use the EventObject(<em>name</em>) MACRO to create and initialize <a class="el" href="classEvent.html" title="Abstract class for events used as StateMachine triggers to transition between states. Events must be explicitly tied to a current State and state to transition to once the event has been triggered. This is done using a Transition object in a designed StateMachine. ">Event</a> objects <code><a class="el" href="StateMachine_8h.html#ac55e5bc46f7171fea0bbb3880b279a63" title="Macros to quickly create event objects given their names as input. useage: EventObject ( MyEvent ) * ...">EventObject(IsAPressed)</a> * isAPressed;</code> &amp; <code>isAPressed = new IsAPressed(*this*);</code></li>
<li>Define <a class="el" href="classEvent.html" title="Abstract class for events used as StateMachine triggers to transition between states. Events must be explicitly tied to a current State and state to transition to once the event has been triggered. This is done using a Transition object in a designed StateMachine. ">Event</a> object check() functions as above (in Statemachine class)</li>
<li>Pass your first state to the Base <a class="el" href="classStateMachine.html" title="Abstract class representing a state machine. Includes a number of State and Transition objects...">StateMachine</a> <code>initialize(state)</code> function -&gt; <code>StateMachine::initialize(initState)</code></li>
<li>In your main program cyclically call <code>&lt;yourStaeMachine&gt;.update()</code> </li>
</ol>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
